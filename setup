#!/bin/bash

# this script installs rgpIO followinf SetupHelper rules (https://github.com/kwindrem/SetupHelper)
#


#### following lines incorporate SetupHelper utilities into this script
# Refer to the SetupHelper ReadMe file for details.

source "/data/SetupHelper/CommonResources"

#### end of lines to include SetupHelper


restartSystemCalc=false
restartGeneratorService=false


#### running manually and OK to proceed - prompt for input
if [ $scriptAction == 'NONE' ] ; then
    echo
    echo "The rgpIO is adding external Relays and Digital Inputs"
    echo "with external box attached via USB port"
    echo
    standardActionPrompt
fi

#### here to do the actual work

if [ $scriptAction == 'INSTALL' ] ; then
    logMessage "++ Installing rgpIO"

    cd /data/
    wget github.com/Lucifer06/Venus_rgpio/releases/download/Latest/rgpio.tar.gz
    tar -xvzf rgpio.tar.gz
    rm rgpio.tar.gz

    ##
    ## Creating /dev/gpio links at boot so the bus services are automatically created 
    ##
    ln -s /data/rgpio/conf/S90rgpio_pins.sh /etc/rcS.d/S90rgpio_pins.sh

    ##
    ## Update Relaystate Python script
    ##
    if [ ! -e /data/rgpio/conf/relaystate.py.ori ]
    then
      logMessage "Archiving relaystate.py"
      mv /opt/victronenergy/dbus-systemcalc-py/delegates/relaystate.py /data/rgpio/conf/relaystate.py.ori
      cp /data/rgpio/conf/relaystate.py /opt/victronenergy/dbus-systemcalc-py/delegates/relaystate.py
    else
      logMessage "relaystate.py already archived"
      cp /data/rgpio/conf/relaystate.py /opt/victronenergy/dbus-systemcalc-py/delegates/relaystate.py
    fi

    ##
    ## Need to add Relays 3, 4, 5 and 6 in /etc/venus/gpio_list so they can be configured on the GUI
    ##
    if [ ! -e /data/rgpio/conf/gpio_list.ori ]
    then
      logMessage "Archiving gpio_list"
      mv /etc/venus/gpio_list /data/rgpio/conf/gpio_list.ori
      cp /data/rgpio/conf/gpio_list  /etc/venus/gpio_list
    else
      logMessage "gpio_list already archived"
      cp /data/rgpio/conf/gpio_list  /etc/venus/gpio_list
    fi

    ##
    ## Need to update Node-Red service for adding the 4x relays
    ##
    ##
    if [ ! -e /data/rgpio/conf/services.json.ori ]
    then
      logMessage "Archiving services.json"
      mv /usr/lib/node_modules/@victronenergy/node-red-contrib-victron/src/services/services.json /data/rgpio/conf/services.json.ori
      cp /data/rgpio/conf/services.json /usr/lib/node_modules/@victronenergy/node-red-contrib-victron/src/services/services.json
    else
      logMessage "services.json already archived"
      cp /data/rgpio/conf/services.json /usr/lib/node_modules/@victronenergy/node-red-contrib-victron/src/services/services.json
    fi

    updateActiveFile /opt/victronenergy/dbus-systemcalc-py/delegates/relaystate.py 
    updateActiveFile /etc/venus/gpio_list
    updateActiveFile /usr/lib/node_modules/@victronenergy/node-red-contrib-victron/src/services/services.json

    installService $packageName
fi

# #### uninstalling - check scriptAction again
# if an install step failed package needs to be removed
if [ $scriptAction == 'UNINSTALL' ] ; then
    logMessage "++ Uninstalling rgpIO"

    restoreActiveFile /opt/victronenergy/dbus-systemcalc-py/delegates/relaystate.py 
    restoreActiveFile /etc/venus/gpio_list
    restoreActiveFile /usr/lib/node_modules/@victronenergy/node-red-contrib-victron/src/services/services.json
    removeService $packageName
fi



if $filesUpdated ; then
    ##
    ## Reboot or restart the services
    ##
    svc -d /service/dbus-systemcalc-py/ ; svc -u /service/dbus-systemcalc-py/
#    svc -d /service/gui ; svc -u /service/gui
    svc -d /service/node-red-venus
    restartGui=true
fi

# thats all folks - SCRIPT EXITS INSIDE THE FUNCTION
endScript

